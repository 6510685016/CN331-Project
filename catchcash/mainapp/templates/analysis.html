{% extends "base.html" %}

{% block title %}
About CatchCASH
{% endblock %}

{% block content %}

<style>
    .incomeExpenses-Box {
        height: 40vh;
        width: 70vw;
        background-color: #00ffd51a;
        border-radius: 30px;
        margin-left: 50px;
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .incomeVsExpenses-box {
        height: 60vh;
        width: 22vw;
        background-color: #00ffd51a;
        border-radius: 30px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;

    }

    .summary-Box {
        height: 60vh;
        width: 90vw;
        background-color: #00ffd51a;
        border-radius: 30px;
        margin-top: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
</style>


    <div class="d-flex">
        <!-- Left Box: Charts -->
        <div class="w-75 mt-3">

            <!-- Income Chart -->
            <div class="d-flex flex-column align-items-center">
                <h4 class="fw-bold">Income</h4>
            </div>
            <div class="incomeExpenses-Box border">
                <canvas id="IncomeChart" class="p-3 w-100 h-100"></canvas>
                <div id="no-data-message1" class="text-center"
                    style="display: none; height: 50px; width: 100%; background-color: rgb(222, 224, 127);">
                    <h5 class=" mt-3 text-muted fw-bold">No Income Data Available</h5>
                </div>
            </div>

            <!-- Expenses Chart -->
            <div class="d-flex flex-column align-items-center mt-3">
                <h4 class="fw-bold">Expenses</h4>
            </div>
            <div class="incomeExpenses-Box border">
                <canvas id="ExpensesChart" class="p-3 w-100 h-100"></canvas>
                <div id="no-data-message2" class="text-center"
                    style="display: none; height: 50px; width: 100%; background-color: rgb(222, 224, 127);">
                    <h5 class="mt-3 text-muted fw-bold">No Expense Data Available</h5>
                </div>
            </div>


        </div>

        <!-- Right Box: Filter & Income Vs Expense Box-->
        <div class="w-25">
            <!-- Wallet & Date Filter-->
            <div class="justify-content-end text-end mt-3 mb-3 me-5">
                <label for="wallet-select" class="visually-hidden">Select Wallet</label>
                <select id="wallet-select" name="wallet" class="btn me-2 border" style=" background-color: #F7EFFF;"
                    onchange="applyFilter()">
                    {% if wallets %}
                    {% for wallet in wallets %}
                    <option value="{{ wallet.id }}">{{ wallet.wName }}</option>
                    {% endfor %}
                    {% else %}
                    <option value="" disabled selected>No Wallets Available</option>
                    {% endif %}
                </select>

                <input type="date" id="date-select" name="date" class="btn border" style=" background-color: #F7EFFF;"
                    onchange="applyFilter()">
            </div>

            <!-- Income Vs Expense Box -->
            <div class="incomeVsExpenses-box position-relative">
                <div class="border-bottom p-2 text-center">
                    <h5 class="fw-bold">Income Vs Expense</h5>
                </div>

                <div id="no-data-message3" class="text-center position-absolute top-50 start-50 translate-middle"
                    style="display: none; height: 50px; width: 100%; background-color: rgb(222, 224, 127);">
                    <h5 class="mt-3 text-muted fw-bold">No Income or Expense</h5>
                </div>

                <div class="p-4 w-100 h-100">
                    <canvas id="IncomeVsExpensesChart"></canvas>
                </div>
            </div>

        </div>


    </div>

    <div class="d-flex align-items-center justify-content-center flex-column">
        <div class="mt-3">
            <h4 class="fw-bold">Balance Last 7 Days</h4>
        </div>
        <div class="summary-Box flex-column">
            <canvas id="sevenDaysChart" class="p-3 w-100 h-100"></canvas>
        </div>
    </div>



<script>

    window.onload = function () {
        const defaultDate = new Date();
        const year = defaultDate.getFullYear();
        const month = String(defaultDate.getMonth() + 1).padStart(2, '0');
        const day = String(defaultDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

        console.log(formattedDate);
        document.getElementById("date-select").value = formattedDate;


        applyFilter();
    };


    function loadDataForLastSevenDays(selectedDate) {
        const walletId = document.getElementById("wallet-select").value;
        console.log("Selected Date:", selectedDate, "Wallet ID:", walletId);


        if (!walletId) {
            console.error("No wallet selected.");
            return;
        }


        const balanceList = new Array(7);
        const dateList = [];


        const dayList = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(selectedDate);
            date.setDate(date.getDate() - i);
            dayList.push(date.toISOString().split('T')[0]);
        }


        const fetchPromises = dayList.map((date, index) => {
            const params = new URLSearchParams({ wallet_id: walletId, date: date });

            return fetch(`/analysis/?${params.toString()}`, { method: 'GET' })
                .then(response => response.ok ? response.json() : Promise.reject('Error'))
                .then(data => {
                    const balance = calculateBalance(data.statement);
                    balanceList[index] = balance;
                    dateList[index] = date;
                })
                .catch(error => {
                    console.error(`Error fetching data for ${date}:`, error);
                    balanceList[index] = 0;
                    dateList[index] = date;
                });
        });


        Promise.all(fetchPromises)
            .then(() => {
                dateList.reverse()
                balanceList.reverse()
                console.log("Date List:", dateList);
                console.log("Balance List:", balanceList);
                createLineChart(balanceList, dateList);
            })
            .catch(error => console.error("Error in fetching data:", error));
    }


    function calculateBalance(statement) {
        let income = 0, outcome = 0;
        if (statement && statement.length > 0) {
            statement.forEach(item => {
                if (item.type === 'in') income += parseFloat(item.amount);
                if (item.type === 'out') outcome += parseFloat(item.amount);
            });
            return income - outcome;
        }
        return 0;
    }


    function createLineChart(balanceList, dateList) {
        const ctx = document.getElementById('sevenDaysChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dateList,
                datasets: [{
                    label: 'Balance',
                    data: balanceList,
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Balance' } }
                }
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }


    function applyFilter() {
        const walletId = document.getElementById("wallet-select").value;
        const selectedDate = document.getElementById("date-select").value || document.getElementById("date-select").defaultValue;


        if (walletId || selectedDate) {
            loadDataForLastSevenDays(selectedDate);

            const params = new URLSearchParams();
            if (walletId) params.append('wallet_id', walletId);
            if (selectedDate) params.append('date', selectedDate);

            fetch(`/analysis/?${params.toString()}`, { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (data.statement && data.statement.length > 0) {
                        let income = 0, outcome = 0;
                        let incomeCategories = {}, expenseCategories = {};

                        data.statement.forEach(statement => {
                            if (statement.type === 'in') {
                                income += parseFloat(statement.amount);
                                incomeCategories[statement.category] = (incomeCategories[statement.category] || 0) + parseFloat(statement.amount);
                            } else if (statement.type === 'out') {
                                outcome += parseFloat(statement.amount);
                                expenseCategories[statement.category] = (expenseCategories[statement.category] || 0) + parseFloat(statement.amount);
                            }
                        });


                        updateIncomeVsExpensesChart(income, outcome);
                        updateIncomeChart(incomeCategories);
                        updateExpensesChart(expenseCategories);

                        document.getElementById('no-data-message1').style.display = 'none';
                        document.getElementById('no-data-message2').style.display = 'none';
                        document.getElementById('no-data-message3').style.display = 'none';
                        document.getElementById('IncomeVsExpensesChart').style.display = 'block';
                        document.getElementById('IncomeChart').style.display = 'block';
                        document.getElementById('ExpensesChart').style.display = 'block';
                    } else {
                        document.getElementById('no-data-message1').style.display = 'block';
                        document.getElementById('no-data-message2').style.display = 'block';
                        document.getElementById('no-data-message3').style.display = 'block';
                        document.getElementById('IncomeVsExpensesChart').style.display = 'none';
                        document.getElementById('IncomeChart').style.display = 'none';
                        document.getElementById('ExpensesChart').style.display = 'none';
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    // Update Income vs Outcome Doughnut Chart
    function updateIncomeVsExpensesChart(income, outcome) {
        const ctx = document.getElementById('IncomeVsExpensesChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Income', 'Outcome'],
                datasets: [{
                    data: [income, outcome],
                    backgroundColor: ['#4CAF50', '#F44336'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Update Income Bar Chart
    function updateIncomeChart(incomeCategories) {
        const ctx = document.getElementById('IncomeChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(incomeCategories),
                datasets: [{
                    label: 'Income by Category',
                    data: Object.values(incomeCategories),
                    backgroundColor: '#4CAF50',
                    borderColor: '#388E3C',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
            }
        });
    }

    // Update Expenses Bar Chart
    function updateExpensesChart(expenseCategories) {
        const ctx = document.getElementById('ExpensesChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(expenseCategories),
                datasets: [{
                    label: 'Expenses by Category',
                    data: Object.values(expenseCategories),
                    backgroundColor: '#F44336',
                    borderColor: '#D32F2F',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

</script>


{% endblock %}