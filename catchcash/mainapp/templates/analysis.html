{% extends "base.html" %}

{% block title %}
Analysis CatchCASH
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
</head>

<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .d-flex {
        display: flex;
        flex-wrap: nowrap;
        height: 100%;
        overflow: hidden;
    }

    .flex-grow-1 {
        flex-grow: 1;
    }

    .incomeExpenses-Box,
    .incomeVsExpenses-box,
    .summary-Box {
        box-sizing: border-box;
        overflow-y: auto; /* Allow scrolling inside individual charts if content overflows */
    }

    .incomeExpenses-Box {
        height: 40vh;
        width: 70%;
        border-radius: 15px;
        background-color: #e6f7ff;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 10px auto;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .incomeVsExpenses-box {
        height: 60vh;
        border-radius: 15px;
        background-color: #e6f7ff;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .summary-Box {
        height: 60vh;
        width: 90%;
        border-radius: 15px;
        background-color: #e6f7ff;
        margin: 20px auto;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .main-content {
        overflow-y: auto;
        height: calc(100vh - 80px); /* Adjust based on your header/footer height */
    }

    canvas {
        max-width: 100%;
        max-height: 100%;
    }
</style>

<body class="m-0 p-0 vh-100 d-flex flex-column">
    <div class="d-flex flex-grow-1 overflow-hidden">
        <!-- Left Section: Charts -->
        <div class="d-flex flex-column w-75 overflow-auto px-4">
            <!-- Income Chart -->
            <div class="d-flex flex-column align-items-center mt-3">
                <h4 class="fw-bold">Income</h4>
                <div class="incomeExpenses-Box border">
                    <canvas id="IncomeChart"></canvas>
                    <div id="no-data-message1" class="text-center" style="display: none;">
                        <h5 class="mt-3 text-muted fw-bold">No Income Data Available</h5>
                    </div>
                </div>
            </div>

            <!-- Expenses Chart -->
            <div class="d-flex flex-column align-items-center mt-4">
                <h4 class="fw-bold">Expenses</h4>
                <div class="incomeExpenses-Box border">
                    <canvas id="ExpensesChart"></canvas>
                    <div id="no-data-message2" class="text-center" style="display: none;">
                        <h5 class="mt-3 text-muted fw-bold">No Expense Data Available</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Section: Filter & Income vs Expense -->
        <div class="d-flex flex-column w-25 p-3">
            <div class="text-end mb-3">
                <select id="wallet-select" class="form-select mb-2" onchange="applyFilter()">
                    {% if wallets %}
                    {% for wallet in wallets %}
                    <option value="{{ wallet.id }}">{{ wallet.wName }}</option>
                    {% endfor %}
                    {% else %}
                    <option value="" disabled>No Wallets Available</option>
                    {% endif %}
                </select>
                <input type="date" id="date-select" class="form-control" onchange="applyFilter()">
            </div>
            <div class="incomeVsExpenses-box border">
                <h5 class="text-center fw-bold mt-3">Income Vs Expenses</h5>
                <canvas id="IncomeVsExpensesChart"></canvas>
                <div id="no-data-message3" class="text-center" style="display: none;">
                    <h5 class="mt-3 text-muted fw-bold">No Income or Expense</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-Box mx-auto mt-4">
        <h4 class="text-center">Balance Last 7 Days</h4>
        <canvas id="sevenDaysChart"></canvas>
    </div>
</body>

<script>

    window.onload = function () {
        const defaultDate = new Date();
        const year = defaultDate.getFullYear();
        const month = String(defaultDate.getMonth() + 1).padStart(2, '0');
        const day = String(defaultDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

        console.log(formattedDate);
        document.getElementById("date-select").value = formattedDate;


        applyFilter();
    };


    function loadDataForLastSevenDays(selectedDate) {
        const walletId = document.getElementById("wallet-select").value;
        console.log("Selected Date:", selectedDate, "Wallet ID:", walletId);


        if (!walletId) {
            console.error("No wallet selected.");
            return;
        }


        const balanceList = new Array(7);
        const dateList = [];


        const dayList = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(selectedDate);
            date.setDate(date.getDate() - i);
            dayList.push(date.toISOString().split('T')[0]);
        }


        const fetchPromises = dayList.map((date, index) => {
            const params = new URLSearchParams({ wallet_id: walletId, date: date });

            return fetch(`/analysis/?${params.toString()}`, { method: 'GET' })
                .then(response => response.ok ? response.json() : Promise.reject('Error'))
                .then(data => {
                    const balance = calculateBalance(data.statement);
                    balanceList[index] = balance;
                    dateList[index] = date;
                })
                .catch(error => {
                    console.error(`Error fetching data for ${date}:`, error);
                    balanceList[index] = 0;
                    dateList[index] = date;
                });
        });


        Promise.all(fetchPromises)
            .then(() => {
                dateList.reverse()
                balanceList.reverse()
                console.log("Date List:", dateList);
                console.log("Balance List:", balanceList);
                createLineChart(balanceList, dateList);
            })
            .catch(error => console.error("Error in fetching data:", error));
    }


    function calculateBalance(statement) {
        let income = 0, outcome = 0;
        if (statement && statement.length > 0) {
            statement.forEach(item => {
                if (item.type === 'in') income += parseFloat(item.amount);
                if (item.type === 'out') outcome += parseFloat(item.amount);
            });
            return income - outcome;
        }
        return 0;
    }


    function createLineChart(balanceList, dateList) {
        const ctx = document.getElementById('sevenDaysChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dateList,
                datasets: [{
                    label: 'Balance',
                    data: balanceList,
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Balance' } }
                }
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }


    function applyFilter() {
        const walletId = document.getElementById("wallet-select").value;
        const selectedDate = document.getElementById("date-select").value || document.getElementById("date-select").defaultValue;


        if (walletId || selectedDate) {
            loadDataForLastSevenDays(selectedDate);

            const params = new URLSearchParams();
            if (walletId) params.append('wallet_id', walletId);
            if (selectedDate) params.append('date', selectedDate);

            fetch(`/analysis/?${params.toString()}`, { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (data.statement && data.statement.length > 0) {
                        let income = 0, outcome = 0;
                        let incomeCategories = {}, expenseCategories = {};

                        data.statement.forEach(statement => {
                            if (statement.type === 'in') {
                                income += parseFloat(statement.amount);
                                incomeCategories[statement.category] = (incomeCategories[statement.category] || 0) + parseFloat(statement.amount);
                            } else if (statement.type === 'out') {
                                outcome += parseFloat(statement.amount);
                                expenseCategories[statement.category] = (expenseCategories[statement.category] || 0) + parseFloat(statement.amount);
                            }
                        });


                        updateIncomeVsExpensesChart(income, outcome);
                        updateIncomeChart(incomeCategories);
                        updateExpensesChart(expenseCategories);

                        document.getElementById('no-data-message1').style.display = 'none';
                        document.getElementById('no-data-message2').style.display = 'none';
                        document.getElementById('no-data-message3').style.display = 'none';
                        document.getElementById('IncomeVsExpensesChart').style.display = 'block';
                        document.getElementById('IncomeChart').style.display = 'block';
                        document.getElementById('ExpensesChart').style.display = 'block';
                    } else {
                        document.getElementById('no-data-message1').style.display = 'block';
                        document.getElementById('no-data-message2').style.display = 'block';
                        document.getElementById('no-data-message3').style.display = 'block';
                        document.getElementById('IncomeVsExpensesChart').style.display = 'none';
                        document.getElementById('IncomeChart').style.display = 'none';
                        document.getElementById('ExpensesChart').style.display = 'none';
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    // Update Income vs Expenses Doughnut Chart
    function updateIncomeVsExpensesChart(income, outcome) {
        const ctx = document.getElementById('IncomeVsExpensesChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Income', 'Expenses'],
                datasets: [{
                    data: [income, outcome],
                    backgroundColor: ['#4CAF50', '#F44336'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Update Income Bar Chart
    function updateIncomeChart(incomeCategories) {
        const ctx = document.getElementById('IncomeChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(incomeCategories),
                datasets: [{
                    label: 'Income by Category',
                    data: Object.values(incomeCategories),
                    backgroundColor: '#4CAF50',
                    borderColor: '#388E3C',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
            }
        });
    }

    // Update Expenses Bar Chart
    function updateExpensesChart(expenseCategories) {
        const ctx = document.getElementById('ExpensesChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(expenseCategories),
                datasets: [{
                    label: 'Expenses by Category',
                    data: Object.values(expenseCategories),
                    backgroundColor: '#F44336',
                    borderColor: '#D32F2F',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

</script>



{% endblock %}

